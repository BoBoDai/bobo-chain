# é¡¹ç›®è¯´æ˜

### 1 **Rust ç®€å•åŒºå—é“¾ï¼ˆæ”¯æŒ PoWï¼‰**

æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªä½¿ç”¨ **Rust** ç¼–å†™çš„ **ç®€æ˜“åŒºå—é“¾ç³»ç»Ÿ**ï¼ŒåŒ…å« å·¥ä½œé‡è¯æ˜ï¼ˆPoWï¼‰ï¼Œæ”¯æŒé€šè¿‡ç»ˆç«¯å‘½ä»¤æ·»åŠ åŒºå—ã€‚

### 2 åŠŸèƒ½

- åŒºå—é“¾åŠŸèƒ½å®ç°
- å·¥ä½œé‡è¯æ˜ï¼ˆå¯è°ƒæ•´éš¾åº¦ï¼‰
- æŒä¹…åŒ–
- é“¾hashå®‰å…¨éªŒè¯
- ç»ˆç«¯äº¤äº’

### 3 æ•°æ®ç»“æ„

- core::Block

```rust
#[derive(Debug, Serialize, Deserialize, PartialEq)]
pub struct BlockHeader {
    pub time: i64,
    // å½“å‰å—æ•°æ®å”¯ä¸€å“ˆå¸Œ
    pub tx_hash: String,
    // ä¸Šä¸€ä¸ªå—çš„å“ˆå¸Œ
    pub pre_hash: String,
    // æŒ–çŸ¿éš¾åº¦
    difficulty: i32,
    // å—é€’å¢éšæœºæ•°
    nonce: u64,
}

#[derive(Debug, Serialize, Deserialize, PartialEq)]
pub struct Block {
    pub header: BlockHeader,
    pub hash: String,
    pub data: String,
}
```

- core::BlockChain

```rust
#[derive(Debug, Deserialize, Serialize, PartialEq)]
pub struct BlockChain {
    //é“¾çš„è½½ä½“
    pub blocks: Vec<Block>,
    // å·¥ä½œé‡è¯æ˜çš„éš¾åº¦
    difficulty: i32,
}
```

### 4 PoW å®ç°

åœ¨ç”Ÿæˆæ¯ä¸€ä¸ªåŒºå—æ—¶è°ƒç”¨ã€‚

```rust
fn proof_of_work(&mut self) {
        if self.header.difficulty < 0 {
            return;
        }
        let target_prefix = "0".repeat(self.header.difficulty as usize);
        while !self.hash.starts_with(&target_prefix) {
            self.hash = self.calculate_hash();
            self.header.nonce += 1;
        }
}
```

å¦‚æœæ˜¯åˆ›ä¸–åŒºå— éš¾åº¦ç³»æ•°ä¸º -1 ä¸éœ€è¦è¿›è¡Œè¯æ˜

```rust
    fn new_genesis_block() -> Block {
        Block::new_block("Genesis block".to_string(), String::from(""), -1)
    }
```



å…¶å®ƒåŒºå—é€šè¿‡è®¡ç®—åŒºå—`header`çš„`hash`æ˜¯å¦æœ‰æŒ‡å®šä¸ªå‰ç¼€0ä½œä¸ºå·¥ä½œå®Œæˆæ ‡å‡†ï¼Œé€’å¢éšæœºæ•°æ¯æ¬¡é€’å¢1ã€‚

### 5 æŒä¹…åŒ–

æŒä¹…åŒ–æ¨¡å—åˆ†ç¦»æ–¹ä¾¿æ‰©å±•

/ Cargo.toml

```toml
[workspace]
members = [
    "main",
    "core",
    "utils",
    "file_db"]
```

åç»­æ‰©å±•çš„æŒä¹…åŒ–éƒ½éœ€è¦å®ç°Dbçš„æ¥å£

```rust
pub trait DbTrait {
    fn save_chain(&self, chain: &mut BlockChain);
    fn load_chain(&self) -> BlockChain;
    fn is_chain_exist(&self) -> bool;
}
```

é‡‡ç”¨æ–‡ä»¶ç³»ç»Ÿå¯¹é“¾è¿›è¡ŒæŒä¹…åŒ–ï¼Œä¿å­˜ä¸ºå¯è¯»çš„Json

```rust
fn save_chain(&self, block_chain: &mut BlockChain) {
        let json = serde_json::to_string(block_chain).unwrap();
        let mut file = fs::File::create(FILE_NAME).unwrap();
        file.write(json.as_bytes()).unwrap();
    }
```

åŒæ ·æœ‰åŠ è½½è¿‡ç¨‹

```rust
    fn load_chain(&self) -> BlockChain {
        let mut file = fs::File::open(FILE_NAME).unwrap();
        let data: BlockChain = serde_json::from_reader(&mut file).unwrap();
        data
    }
```

è°ƒç”¨æ—¶æœº

åœ¨ç¨‹åºå¯åŠ¨ä¼šåˆ¤æ–­æ˜¯å¦æœ‰å†å²æ•°æ®ï¼Œæœ‰å°±åŠ è½½ï¼Œæ²¡æœ‰å°±åˆ›å»ºæ–°é“¾å¹¶æŒä¹…åŒ–

```rust
    pub fn new_block_chain(difficulty: i32, db: &dyn DbTrait) -> BlockChain {
        if db.is_chain_exist() {
            return db.load_chain()
        }
        let mut chain = BlockChain {
            blocks: vec![BlockChain::new_genesis_block()],
            difficulty,
        };
        db.save_chain(&mut chain);// <- è°ƒç”¨
        chain
    }
```

å½“æ„å»ºå¥½æ–°å—å¹¶æ›´æ–°åˆ°é“¾ä¸Šåï¼Œè°ƒç”¨ä¿å­˜æ•´ä¸ªé“¾ã€‚

```rust
    pub fn add_block(&mut self, data: String, db: &dyn DbTrait) -> Result<(), String> {
        let pre_block = &self.blocks.last().unwrap();
        let new_block = Block::new_block(data, pre_block.hash.clone(), self.difficulty);
        if self.block_chain_is_valid() {//<- è°ƒç”¨éªŒè¯é“¾æ˜¯å¦è¢«ä¿®æ”¹
            self.blocks.push(new_block);
            db.save_chain(self);// <-è°ƒç”¨
            Ok(())
        } else {
            Err("valid failed".to_string())// <- éªŒè¯å¤±è´¥è¿”å›message
        }
    }
```

### 6 é“¾å®‰å…¨éªŒè¯

é€šè¿‡éå†åŒºå—é“¾åˆ°é“¾å°¾ï¼Œå¯¹æ¯”å‰ä¸€ä¸ªé“¾çš„hashå’Œåä¸€ä¸ªé“¾çš„pre_hashæ¥ä¿è¯å®‰å…¨ï¼Œè°ƒç”¨ä½ç½®è§ç¬¬äº”èŠ‚æœ€åä¸€ä¸ªä»£ç å—ã€‚

```rust
    fn block_chain_is_valid(&self) -> bool {
        for i in 1..self.blocks.len() {
            let block = &self.blocks[i];
            let pre_block = &self.blocks[i - 1];
            if block.header.pre_hash != pre_block.hash {
                return false;
            }
        }
        true
    }
```

ç”±äºè¦åŠ å…¥çš„å—ä¾èµ–å½“å‰æœ€åä¸€ä¸ªå—ç”Ÿæˆæ‰€ä»¥æ— æ³•æ ¡éªŒã€‚

### 7 ç»ˆç«¯äº¤äº’

ç”¨CliHandleråŒ…è£…äº¤äº’é€»è¾‘æµ

```rust
fn main() {
    let db = Db;// <- åŠ è½½å¯¹åº”å­˜å‚¨ç³»ç»Ÿ
    // æ–°å»ºé“¾
    let mut bc = block_chain::BlockChain::new_block_chain(4, &db);//<-æ‹¿åˆ°é“¾
    CliHandler::run(&mut bc, &db);//<-äº¤äº’é€»è¾‘
}
```

 CliHandler::runä¸»è¦è¾“å‡ºå‡ ç§ä¿¡æ¯å¹¶éƒ½æœ‰å¯¹åº”æç¤º

- `ğŸ”¹ è¯·è¾“å…¥æŒ‡ä»¤ (æˆ–è¾“å…¥ 'exit' é€€å‡º): `ï¼šç­‰å¾…é˜¶æ®µ
- `ğŸ‘‹  é€€å‡ºåŒºå—é“¾...`ï¼šé€€å‡ºæç¤º
- `â›ï¸ æ­£åœ¨åˆ›å»ºåŒºå—`ï¼šåŒºå—åˆ›å»ºä¸­
- `ğŸ’µ åˆ›å»ºå®Œæˆ`ï¼šåˆ›å»ºå®Œæˆæç¤º
- `âŒ é“¾è¢«æ›´æ”¹ï¼Œæ— æ³•æ–°å¢åŠ åŒºå—ã€‚`ï¼šé“¾è¢«ä¿®æ”¹æŠ¥é”™æç¤ºï¼Œè§£å†³åŠæ³•åªæœ‰åˆ é™¤æ•°æ®
- `âŒ è¯·è¾“å…¥ add åŠ äº¤æ˜“ä¿¡æ¯æ·»åŠ åŒºå—ï¼Œè¾“å…¥listæŸ¥çœ‹å½“å‰é“¾ã€‚`ï¼šè¾“å…¥help

### 8 è¿è¡Œæ¼”ç¤º

#### 8.1ã€ä½äºé¡¹ç›®æ ¹ç›®å½•å¯åŠ¨é¡¹ç›®

```
cargo run
```

ä¼šçœ‹è§

<img src="./image/image-20250308203617688.png" alt="image-20250308203617688" style="zoom: 67%;" />

#### 8.2ã€è¾“å…¥æŒ‡ä»¤æ·»åŠ åŒºå—

```
add a to b 50 sol
```

å¯çœ‹åˆ°æ­£åœ¨åˆ›å»ºåŒºå—

<img src="./image/image-20250308203911943.png" alt="image-20250308203911943" style="zoom: 67%;" />

ç­‰å·¥ä½œé‡å®Œæˆå¯çœ‹åˆ°åˆ›å»ºå®Œæˆï¼Œç³»ç»Ÿè¿›å…¥ç­‰å¾…é˜¶æ®µ

<img src="./image/image-20250308204050868.png" alt="image-20250308204050868" style="zoom:67%;" />

#### 8.3 æŸ¥çœ‹åŒºå—list

è¾“å…¥listå¯ä»¥æŸ¥çœ‹å½“å‰åŒºå—é“¾æ•°æ®

```
list
```

<img src="./image/image-20250308211302916.png" alt="image-20250308211302916" style="zoom:50%;" />

#### 8.4 è¾“å…¥exité€€å‡ºç¨‹åº

```
exit
```

<img src="./image/image-20250308204333820.png" alt="image-20250308204333820" style="zoom:67%;" />

#### 8.5 åœ¨æ‰“å¼€ç¨‹åºè¾“å…¥listå¯ä»¥æŸ¥çœ‹ä¹‹å‰çš„æ•°æ®

```
cargo run
```

```
list
```

<img src="./image/image-20250308210256157.png" alt="image-20250308210256157" style="zoom:50%;" />

#### 8.6 æ¶æ„ç¯¡æ”¹ä¸­é—´å—çš„hashæ— æ³•æ’å…¥æ–°å—

å†å…ˆæ’å…¥ä¸€ä¸ªå—ä¹‹åé€€å‡ºç¨‹åº

```
add b to c 50 sol
```

```
exit
```

<img src="./image/image-20250308211353836.png" alt="image-20250308211353836" style="zoom:50%;" />

ä¹‹åä¿®æ”¹æœ¬åœ°å­˜å‚¨æ–‡ä»¶ä¸­ç¬¬äºŒä¸ªå—çš„ä¸€ä¸ªhashï¼Œå¦‚æœä¿®æ”¹æœ€åä¸€ä¸ªå—çš„hashéœ€è¦å¼•å…¥æ–°çš„éªŒè¯æ–¹å¼æ‰èƒ½éªŒè¯å‡ºæ¥

![image-20250308211522633](./image/image-20250308211522633.png)

ä¹‹åå¯åŠ¨é¡¹ç›®å°è¯•æ·»åŠ æ–°å—

```
cargo run
```

```
add c to d 50 sol
```

å‡ºç°æŠ¥é”™æç¤º

<img src="./image/image-20250308211627878.png" alt="image-20250308211627878" style="zoom: 50%;" />

#### 8.7 è¾“å…¥ä¹±ç 

ä¸ºä¿æŠ¤ç³»ç»Ÿï¼Œå¦‚æœè¾“å…¥ä¸è¯†åˆ«çš„æŒ‡ä»¤å¦‚

```
dslkjfhsldkjafhdsl
```

ä¼šå‡ºç°æç¤ºè¿›è¡Œå¼•å¯¼

<img src="./image/image-20250308211806545.png" alt="image-20250308211806545" style="zoom:50%;" />

